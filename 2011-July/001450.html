<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Mapnik-devel] Support attachdb and initdb parameters in sqlite	plugin
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/mapnik-devel/2011-July/index.html" >
   <LINK REL="made" HREF="mailto:mapnik-devel%40lists.berlios.de?Subject=Re%3A%20%5BMapnik-devel%5D%20Support%20attachdb%20and%20initdb%20parameters%20in%20sqlite%0A%09plugin&In-Reply-To=%3CACBCDC6A-F1F0-40E4-B45C-3BAF937E9821%40dbsgeo.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001444.html">
   <LINK REL="Next"  HREF="001439.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Mapnik-devel] Support attachdb and initdb parameters in sqlite	plugin</H1>
    <B>Dane Springmeyer</B> 
    <A HREF="mailto:mapnik-devel%40lists.berlios.de?Subject=Re%3A%20%5BMapnik-devel%5D%20Support%20attachdb%20and%20initdb%20parameters%20in%20sqlite%0A%09plugin&In-Reply-To=%3CACBCDC6A-F1F0-40E4-B45C-3BAF937E9821%40dbsgeo.com%3E"
       TITLE="[Mapnik-devel] Support attachdb and initdb parameters in sqlite	plugin">dane at dbsgeo.com
       </A><BR>
    <I>Thu Jul 14 20:40:03 CEST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="001444.html">[Mapnik-devel] Support attachdb and initdb parameters in sqlite	plugin
</A></li>
        <LI>Next message: <A HREF="001439.html">[Mapnik-devel] Two new Mapnik Java Projects
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1450">[ date ]</a>
              <a href="thread.html#1450">[ thread ]</a>
              <a href="subject.html#1450">[ subject ]</a>
              <a href="author.html#1450">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Lucio,

Great, thanks for confirming, I agree. I've created a new ticket to track this 'auto' spatialite detection/support:

<A HREF="http://trac.mapnik.org/ticket/798">http://trac.mapnik.org/ticket/798</A>

Dane


On Jul 12, 2011, at 12:22 AM, kRAkEn/gORe wrote:

&gt;<i> That's is perfectly fine for me. I wonder why i didn't use that already ?
</I>&gt;<i> I think however we should support both, as differences are minimal.
</I>&gt;<i> I'm just trying to find a way to automagically select the WKB format,
</I>&gt;<i> so one doesn't need to specify the wkb_format every time.
</I>&gt;<i> 
</I>&gt;<i> btw i'm using spatialite cause it offers also good tools and libraries
</I>&gt;<i> to manipulate/interact with the features in databases.
</I>&gt;<i> 
</I>&gt;<i> cheers
</I>&gt;<i> 
</I>&gt;<i> Lucio
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> On Mon, Jul 11, 2011 at 6:00 PM, Dane Springmeyer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/mapnik-devel">dane at dbsgeo.com</A>&gt; wrote:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> On Jul 6, 2011, at 2:55 AM, kRAkEn/gORe wrote:
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Hi all,
</I>&gt;&gt;&gt;<i> the metadata table is something present in spatialite databases (but
</I>&gt;&gt;&gt;<i> is there also on oracle too) that allows to query for extent instead
</I>&gt;&gt;&gt;<i> of manually specifying it or recalculating everytime.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Ah, sorry did not realize this was a spatialite feature - great to know, we'll keep then :)
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Lucio - that raises another question I've had for you. My recent work on the sqlite driver has worked to slightly improve the support for using sqlite without spatiallite. Since sqlite supports RTREE indexes natively I allowed the extent to be automatically pulled from the index (if it exists): <A HREF="http://trac.mapnik.org/changeset/2689/trunk/plugins/input/sqlite.">http://trac.mapnik.org/changeset/2689/trunk/plugins/input/sqlite.</A> Also in that commit I changed the driver to use the native &quot;rowid&quot; for the default primary key instead of the Spatialite PK_UID.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Do these seem acceptable to you from the perspective of keeping solid spatialite support?
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> My general thought is that ideally we can support both, nearly automatically. The only thing preventing this is that the user must now manually supply wkb_format=&quot;spatialite&quot; to trigger usage of the spatialite geometry (which otherwise fails silently). Ideally we could autodetect a spatialite db, and therefore autodetect the wkb format while throwing if it is not valid.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Thoughts?
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Dane
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> i find it pretty useful information, and automatize and speed up
</I>&gt;&gt;&gt;<i> extent querying for my layers.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Lucio
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> On Wed, Jul 6, 2011 at 12:27 AM, Stella Laurenzo &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/mapnik-devel">stella at laurenzo.org</A>&gt; wrote:
</I>&gt;&gt;&gt;&gt;<i> Dane,
</I>&gt;&gt;&gt;&gt;<i> As soon as I sent that email, I thought &quot;crap, I meant
</I>&gt;&gt;&gt;&gt;<i> to propagate index_table_ through the rest of the file.&quot;  :)  It probably
</I>&gt;&gt;&gt;&gt;<i> also makes sense to allow it to be set with a parameter instead of always
</I>&gt;&gt;&gt;&gt;<i> auto calculated.
</I>&gt;&gt;&gt;&gt;<i> I'll see if Lucio knows what's going on with the metadata bits.  I'm not at
</I>&gt;&gt;&gt;&gt;<i> all familiar with them.
</I>&gt;&gt;&gt;&gt;<i> I'll probably circle back around to this on Thursday.
</I>&gt;&gt;&gt;&gt;<i> - stella
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> On Tue, Jul 5, 2011 at 5:24 PM, Dane Springmeyer &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/mapnik-devel">dane at dbsgeo.com</A>&gt; wrote:
</I>&gt;&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;&gt;<i> Stella,
</I>&gt;&gt;&gt;&gt;&gt;<i> Looks good. Only comment is that hat `index_table_` could be leveraged in
</I>&gt;&gt;&gt;&gt;&gt;<i> a few more places to avoid `&quot;idx_&quot; &lt;&lt; geometry_table_ &lt;&lt; &quot;_&quot; &lt;&lt;
</I>&gt;&gt;&gt;&gt;&gt;<i> geometry_field_`. Could you take a look at that?
</I>&gt;&gt;&gt;&gt;&gt;<i> Also, could you pls create a ticket at mapnik trac on this issue, and
</I>&gt;&gt;&gt;&gt;&gt;<i> provide just a bit more detail about the use case/design of attachdb.
</I>&gt;&gt;&gt;&gt;&gt;<i> Also, I'm not super aware of the history of the metadata_ option. Its
</I>&gt;&gt;&gt;&gt;&gt;<i> clear it is an alternate way for the user to provide an extent. But from my
</I>&gt;&gt;&gt;&gt;&gt;<i> perspective its pretty ideal to have an RTREE index, and it might be cleaner
</I>&gt;&gt;&gt;&gt;&gt;<i> to remove the metadata_ option and just throw if the user does not either
</I>&gt;&gt;&gt;&gt;&gt;<i> provide a manual extent (for speedy creation of the datasource) or if it
</I>&gt;&gt;&gt;&gt;&gt;<i> cannot be read from a spatial index. What do you think?
</I>&gt;&gt;&gt;&gt;&gt;<i> /cc lucio (aka kunitoki) who it think added the metadata option early on.
</I>&gt;&gt;&gt;&gt;&gt;<i> Dane
</I>&gt;&gt;&gt;&gt;&gt;<i> On Jul 5, 2011, at 3:59 PM, Stella Laurenzo wrote:
</I>&gt;&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;&gt;<i> Hi all,
</I>&gt;&gt;&gt;&gt;&gt;<i> I've got a sqlite database where some of the tables/indexes are in a
</I>&gt;&gt;&gt;&gt;&gt;<i> separate database file.  In order to use this, I needed mapnik to run an
</I>&gt;&gt;&gt;&gt;&gt;<i> &quot;attach database&quot; command at startup.  I generalized the solution slightly
</I>&gt;&gt;&gt;&gt;&gt;<i> and implemented this in the attached patch, also referenced here on github:
</I>&gt;&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;&gt;<i>    <A HREF="https://github.com/stellaeof/mapnik2/commit/5654bc3ee7cf46657084890ce02bbbbe1c96b101">https://github.com/stellaeof/mapnik2/commit/5654bc3ee7cf46657084890ce02bbbbe1c96b101</A>
</I>&gt;&gt;&gt;&gt;&gt;<i> There are three additions/changes to the sqlite plugin in this commit:
</I>&gt;&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;&gt;<i> Add an attachdb parameter with syntax
</I>&gt;&gt;&gt;&gt;&gt;<i> &quot;<A HREF="https://lists.berlios.de/mailman/listinfo/mapnik-devel">dbname at dbfile</A>[<A HREF="https://lists.berlios.de/mailman/listinfo/mapnik-devel">,dbname2 at dbfile2...</A>]&quot;.  If attached files are not absolute or
</I>&gt;&gt;&gt;&gt;&gt;<i> &quot;:memory:&quot; then they are interpreted relative to the original database file.
</I>&gt;&gt;&gt;&gt;&gt;<i> Add an initdb parameter which allows arbitrary sql to be run when a
</I>&gt;&gt;&gt;&gt;&gt;<i> connection is established.  Any attachments are processed before
</I>&gt;&gt;&gt;&gt;&gt;<i> initialization sql.  This just seemed like a good idea to add since attachdb
</I>&gt;&gt;&gt;&gt;&gt;<i> is just a fancy way to populate the list of initialization sql that this
</I>&gt;&gt;&gt;&gt;&gt;<i> adds to as well.  It may be useful for people to load extensions or set
</I>&gt;&gt;&gt;&gt;&gt;<i> other environment level sqlite options.
</I>&gt;&gt;&gt;&gt;&gt;<i> Fix the detection logic for finding a spatial index so that it works
</I>&gt;&gt;&gt;&gt;&gt;<i> across databases (sqlite_master checks are per database file -
</I>&gt;&gt;&gt;&gt;&gt;<i> select...limit 0 and pragma tableinfo checks are &quot;global&quot; to all attached
</I>&gt;&gt;&gt;&gt;&gt;<i> databases).  This allows the base table to be in one database file and the
</I>&gt;&gt;&gt;&gt;&gt;<i> index in another.
</I>&gt;&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;&gt;<i> I also wrote and committed a new python test that checks all of this out.
</I>&gt;&gt;&gt;&gt;&gt;<i> Let me know what I need to do to get this functionality committed.
</I>&gt;&gt;&gt;&gt;&gt;<i> Thanks.
</I>&gt;&gt;&gt;&gt;&gt;<i> - stella
</I>&gt;&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;&gt;<i> &lt;mapnik_sqlite_attachdb_5654bc3ee7cf46657084.diff&gt;_______________________________________________
</I>&gt;&gt;&gt;&gt;&gt;<i> Mapnik-devel mailing list
</I>&gt;&gt;&gt;&gt;&gt;<i> <A HREF="https://lists.berlios.de/mailman/listinfo/mapnik-devel">Mapnik-devel at lists.berlios.de</A>
</I>&gt;&gt;&gt;&gt;&gt;<i> <A HREF="https://lists.berlios.de/mailman/listinfo/mapnik-devel">https://lists.berlios.de/mailman/listinfo/mapnik-devel</A>
</I>&gt;&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001444.html">[Mapnik-devel] Support attachdb and initdb parameters in sqlite	plugin
</A></li>
	<LI>Next message: <A HREF="001439.html">[Mapnik-devel] Two new Mapnik Java Projects
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1450">[ date ]</a>
              <a href="thread.html#1450">[ thread ]</a>
              <a href="subject.html#1450">[ subject ]</a>
              <a href="author.html#1450">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/mapnik-devel">More information about the Mapnik-devel
mailing list</a><br>
</body></html>
